---
title: "suppfiles"
author: "Arman"
date: "2020-11-17"
output:
  workflowr::wflow_html:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
      number_sections: true
editor_options:
  chunk_output_type: inline
params: 
 from_this_year: 2010
 to_this_year: 2020 
 Developer_mode: TRUE
---

# set up

cansim for downloading the data from public statcan api tidyverse for manipulating and graphing the data janitor for cleaning the names of columns to make them programming language friendly ggthemes for making the graphs look pretty tsibble for handling time series and turning monthly/quarterly data into yearly here package is used for managing directories and to make sure files are saved in the output

```{r include=params$Developer_mode}
here::here()

xfun::pkg_attach2(c("here", "tsibble", "cansim", "janitor", "tidyverse"))

provinces <- c(
  "Alberta", "British Columbia", "Canada", "Manitoba",
  "New Brunswick", "Newfoundland and Labrador", "Nova Scotia", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Northwest Territories", "Nunavut", "Yukon", "Yellowknife, Northwest Territories", "Whitehorse, Yukon", "Iqaluit, Nunavut"
)

twodigitnaics <- c(
  "Accommodation and food services",
  "Administrative and support, waste management and remediation services",
  "Arts, entertainment and recreation",
  "Construction",
  "Educational services",
  "Finance and insurance",
  "Forestry, logging and support",
  "Goods producing industries",
  "Health care and social assistance",
  "Industrial aggregate excluding unclassified businesses",
  "Industrial aggregate including unclassified businesses",
  "Information and cultural industries",
  "Management of companies and enterprises",
  "Manufacturing",
  "Mining, quarrying, and oil and gas extraction",
  "Other services (except public administration)",
  "Professional, scientific and technical services",
  "Public administration",
  "Real estate and rental and leasing",
  "Service producing industries",
  "Trade",
  "Transportation and warehousing",
  "Unclassified businesses",
  "Utilities"
)

```

# CPI
In this section i will be creating the 2 files derieved from the 

##CPI loading and set up

just loading the file; here I define the table number and download it from CANSIM 

```{r loading CPI, include=params$Developer_mode}
tablenumber <- 18100005
CPI <- cansim::get_cansim(tablenumber)
CPI <- janitor::clean_names(CPI)
products_required <- c("All-items", "Food", "Shelter", "Household operations, furnishings and equipment", "Clothing and footwear", "Transportation", "Health and personal care", "Recreation, education and reading", "Alcoholic beverages, tobacco products and recreational cannabis", "Goods", "Services")
```
## CPI Data
here we go about prepping and save an RDS and a csv that has been made human readable; do note the RDS file should be used by other software 

### CPI Rds object
```{r CPI RDS object,include=params$Developer_mode }
#
CPI %>%
  select(ref_date, geo, products_and_product_groups, value, vector) %>%
  filter(products_and_product_groups %in% c(products_required)) %>%
  arrange(products_and_product_groups, geo, ref_date) %>%
  group_by(products_and_product_groups, geo) %>%
  mutate(pct_change = ((value / lag(value, order_by = ref_date)) * 100) - 100) %>%
  mutate(first_dif = (value - lag(value, order_by = ref_date))) %>%
  saveRDS(file = here("output", "RDSobjects", "CPI.rds"))

```
### CPI CSV z
 
 
```{r CSV_FILE, echo=FALSE}

CPI %>%
  select(ref_date, geo, products_and_product_groups, value, vector) %>%
  filter(products_and_product_groups %in% c(products_required)) %>%
  filter(geo %in% c(provinces)) %>%
  arrange(products_and_product_groups, geo, ref_date) %>%
  group_by(products_and_product_groups, geo) %>%
  mutate(pct_change = ((value / lag(value, order_by = ref_date)) * 100) - 100) %>%
  mutate(first_dif = (value - lag(value, order_by = ref_date))) %>%
  filter(ref_date > params$from_this_year) %>%
  pivot_wider(names_from = ref_date, values_from = c(value, pct_change, first_dif)) %>%
  arrange(geo) %>%
  data.table::fwrite(here("output", str_glue("Table_{tablenumber}_CPI_by_province_product_groups_{params$from_this_year}-{params$to_this_year}")))


```
  

```{r echo=FALSE}

CPI %>%
  select(ref_date, geo, products_and_product_groups, value, vector) %>%
  filter(products_and_product_groups %in% c(products_required)) %>%
  filter(geo %in% c(provinces)) %>%
  arrange(products_and_product_groups, geo, ref_date) %>%
  group_by(products_and_product_groups, geo) %>%
  mutate(pct_change = ((value / lag(value, order_by = ref_date)) * 100) - 100) %>%
  mutate(first_dif = (value - lag(value, order_by = ref_date))) %>%
  filter(ref_date > params$from_this_year) %>%
  pivot_wider(names_from = ref_date, values_from = c(value, pct_change, first_dif)) %>%
  arrange(geo) %>%
  DT::datatable(CPI %>%
    select(ref_date, geo, products_and_product_groups, value, vector) %>%
    filter(products_and_product_groups %in% c(products_required)) %>%
    arrange(products_and_product_groups, geo, ref_date) %>%
    group_by(products_and_product_groups, geo) %>%
    mutate(pct_change = ((value / lag(value, order_by = ref_date)) * 100) - 100) %>%
    mutate(first_dif = (value - lag(value, order_by = ref_date))) %>%
    filter(ref_date > params$from_this_year) %>%
    pivot_wider(names_from = ref_date, values_from = c(value, pct_change, first_dif)) %>%
    arrange(geo) %>%
    DT::datatable(filter = "top"))
```

```{r}

```


#Seph 

## SEPH RDS master 
```{r}
tablenumber = "1410020201"
SEPH = cansim::get_cansim(tablenumber)
SEPH = janitor::clean_names(SEPH)
SEPH %>%
  select(ref_date,geo,type_of_employee,north_american_industry_classification_system_naics,value,vector)%>% 
  filter(type_of_employee == "All employees") %>%
  arrange(north_american_industry_classification_system_naics,geo,ref_date) %>% 
  group_by(north_american_industry_classification_system_naics,geo) %>%
  mutate(pct_change =((value/lag(value,order_by = ref_date))*100)-100) %>% 
  mutate(first_dif =(value-lag(value,order_by = ref_date))) %>%
  filter(ref_date > params$from_this_year) %>% 
  saveRDS(file = here("output","RDSobjects","SEPH.rds")) 



  stringr::str_glue("Table_{tablenumber}_SEPH_by_all_NAICS_{params$from_this_year}-{params$to_this_year}")

```

##SEPH for selected industries by province


```{r}
data_tsbl <- as_tsibble(Seph_data ,key = c(`North American Industry Classification System (NAICS)`,Geography))
data_tsbl %>%
  group_by_key() %>%
  index_by(year_month = ~ year(.)) %>%
  summarise(
    avg_value = mean(value,na.rm = TRUE)
  )%>%
  view()
```

#LFS

##  dhoc LFS for presentation (please delete)
```{r}
  tablenum <- 14-10-0023-01 

library(tidyverse)
{{faithful$eruptions}}
all_of(faithful)
all_of()
```




# Raw materials price index



